<h1>Keep On Padding</h1>
<table class="table meta-table table-condensed">
  <tbody>
    <tr>
      <td class="header-column"><strong>Contributed by</strong></td>
      <td>A. P. Marki<br/>Updated based on suggestions by Luc Bourlier</td>
    </tr>
    <tr>
      <td><strong>Source</strong></td>
      <td>N/A</td>
    </tr>
    <tr>
      <td><strong>Tested with Scala version</strong></td>
      <td>2.10.0-RC1</td>
    </tr>
  </tbody>
</table>
<div class="code-snippet">
  <h3>What is the result of executing the following code?</h3>
  <pre class="prettyprint lang-scala">
def padTo(width: Int)(sb: StringBuilder) = {
  0 until (width - sb.length) foreach {
    sb.append('*')
  }
  sb
}

// sb1.length == 14
val sb1 = new StringBuilder("Hello, kitteh!")
println(padTo(20)(sb1))

// sb2.length == 6
val sb2 = new StringBuilder("Hello!")
println(padTo(20)(sb2))
  </pre>
  <ol>
<li><pre class="prettyprint lang-scala">
Hello, kitteh!*
Hello!*
</pre></li>
<li id="correct-answer"><pre class="prettyprint lang-scala">
Hello, kitteh!*
Fails with a runtime exception
</pre></li>
<li><pre class="prettyprint lang-scala">
Hello, kitteh!******
Hello!**************
</pre></li>
<li>
Both fail with a runtime exception
</li>
  </ol>
</div>
<button id="show-and-tell" class="btn btn-primary" href="#">Display the correct answer, explanation and comments</button>
<div id="explanation" class="explanation" style="display:none">
  <h3>Explanation</h3>
  <p>
Recall that Scala has a
<tt>StringBuilder</tt> that
<a href="http://www.artima.com/pins1ed/working-with-lists.html#footnote16-5">
shadows <tt>java.lang.StringBuilder</tt>
</a>
and that it has an
<a href="http://www.scala-lang.org/api/current/index.html#scala.collection.mutable.StringBuilder">
<tt>apply</tt>
</a>
method.
  </p>
  <p>
The <tt>foreach</tt> takes a function with an Int parameter.
<tt>StringBuilder.append</tt> returns a <tt>StringBuilder</tt>, and <tt>StringBuilder</tt> extends <tt>Function1</tt>, so the compiler can just use the returned value as the parameter for the <tt>foreach</tt> call.
Each iteration invokes <tt>StringBuilder.apply</tt>, which is an
alias for <tt>StringBuilder.charAt</tt>.</p>

<p>The code generated by the compiler is equivalent to the following:
<pre class="prettyprint lang-scala">
def padTo(width: Int)(sb: StringBuilder) = {
  val sameSb: StringBuilder = sb.append('*')
  0 until (width - sb.length) foreach(sameSb)
  sb
}
</pre>
If we expand the loop, the reason for the exception becomes clearer. In the <tt>sb2</tt> case, the <tt>StringBuilder</tt> contains only seven characters (<tt>Hello!*</tt> after the call to <tt>append()</tt>. So the <tt>apply</tt> - <tt>charAt</tt> - call fails on the eighth iteration:
<pre class="prettyprint lang-scala">
def padTo(width: Int)(sb: StringBuilder) = {
  val sameSb: StringBuilder = sb.append('*')
  sameSb.apply(0)
  ...
  sameSb.apply(6)
  sameSb.apply(7) // fails here
  ...
  sameSb.apply(13)
  sb
}
</pre>
You can get the expected behaviour by explicitly specifying the function to be used:
<pre class="prettyprint lang-scala">
def padTo(width: Int)(sb: StringBuilder) = {
  0 until (width - sb.length) foreach {
    _ =&gt; sb.append('*')
  }
  sb
}

val sb1 = new StringBuilder("Hello, kitteh!")
println(padTo(20)(sb1)) // prints 'Hello, kitteh!******'

val sb2 = new StringBuilder("Hello!")
println(padTo(20)(sb2)) // prints 'Hello!**************'
</pre>.
  </p>
</div>